<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Attract Loop</title>

  <style>
    html, body {
      margin: 0;
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
    }

    /* Disable selection/highlighting/callouts */
    html, body, * {
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    video {
      width: 100vw;
      height: 100vh;
      object-fit: cover; /* change to 'contain' if you want letterboxing instead of crop */
      display: block;
      background: #000;
    }

    /* Optional subtle hint (remove if you don't want it) */
    .hint {
      position: fixed;
      left: 50%;
      bottom: 3vh;
      transform: translateX(-50%);
      padding: 10px 14px;
      font: 18px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #fff;
      background: rgba(0,0,0,0.45);
      border-radius: 12px;
      pointer-events: none;
      opacity: 0.85;
    }
  </style>
</head>

<body>
  <video id="vid" autoplay muted playsinline preload="auto">
    <source src="attract_loop.mp4" type="video/mp4">
  </video>

  <div class="hint">Tap to begin</div>

  <script>
    // === CONFIG ===
    const DESTINATION_URL = "https://sites.google.com/marinersmuseum.org/ifland-collection-gallery-4/catalog";

    // How often we check drift (ms). 5–10s is plenty.
    const DRIFT_CHECK_MS = 7000;

    // Only correct if drift is larger than this many seconds.
    // 0.35–0.75 is typical; lower = tighter but more likely to “nudge” visibly.
    const DRIFT_THRESHOLD_S = 0.5;
    // =============

    const video = document.getElementById("vid");

    // Block right-click/context menu and text selection.
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("selectstart", e => e.preventDefault());

    // Tap/click/keypress anywhere: go to the Google Site.
    const go = () => window.location.replace(DESTINATION_URL);
    ["pointerdown", "touchstart", "mousedown", "keydown"].forEach(evt => {
      document.addEventListener(evt, go, { passive: true });
    });

    let duration = 0;
    let driftTimer = null;

    // Compute where the video *should* be based on wall clock time.
    function expectedTimeNow() {
      const nowS = Date.now() / 1000;
      return duration ? (nowS % duration) : 0;
    }

    function sync(force = false) {
      if (!duration || !isFinite(duration) || duration <= 0) return;

      // If playback stalled, try to resume.
      if (video.paused) {
        // Try to play; muted+autoplay should work in kiosk contexts.
        video.play().catch(() => {});
      }

      const expected = expectedTimeNow();
      const actual = video.currentTime;

      // Drift on looping media can be weird around the loop point, so normalize:
      let drift = Math.abs(actual - expected);
      if (drift > duration / 2) drift = duration - drift; // wrap-around correction

      if (force || drift > DRIFT_THRESHOLD_S) {
        // Nudge to the expected timestamp.
        video.currentTime = expected;
      }
    }

    video.addEventListener("loadedmetadata", () => {
      duration = video.duration;

      // Initial hard sync so both kiosks land at the same timestamp.
      sync(true);

      // Start drift checks.
      driftTimer = setInterval(() => sync(false), DRIFT_CHECK_MS);

      // Ensure playing.
      video.play().catch(() => {});
    });

    // If the browser tab/app regains focus, re-sync (useful after interruptions).
    window.addEventListener("focus", () => sync(true));
    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) sync(true);
    });

    // If the video errors, at least don’t silently fail.
    video.addEventListener("error", () => {
      // Try reload once
      try {
        video.load();
        setTimeout(() => video.play().catch(() => {}), 250);
      } catch {}
    });
  </script>
</body>
</html>
